<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Expense Tracker</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* Smooth Theme Transition */
      * {
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      body {
        background-color: #f8f9fa;
        color: #212529;
        font-family: "Segoe UI", Tahoma, sans-serif;
      }

      body.dark-mode {
        background-color: #121212 !important;
        color: #e0e0e0 !important;
      }

      /* Cards */
      .card {
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      .card.dark-mode {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      /* Forms & Table */
      .form-control,
      .form-select {
        border-radius: 8px;
      }
      .form-control.dark-mode,
      .form-select.dark-mode {
        background-color: #2a2a2a !important;
        color: #e0e0e0 !important;
        border-color: #444 !important;
      }
      table {
        border-radius: 8px;
        overflow: hidden;
      }
      th,
      td {
        padding: 10px;
        vertical-align: middle;
      }
      table.dark-mode th,
      table.dark-mode td {
        background-color: #1e1e1e !important;
        color: #e0e0e0 !important;
      }

      /* Toggle Button */
      .btn-toggle {
        position: fixed;
        top: 15px;
        right: 15px;
        border: none;
        border-radius: 50%;
        padding: 10px;
        background: #0d6efd;
        color: white;
        font-size: 18px;
        cursor: pointer;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: background 0.3s ease;
      }
      .btn-toggle:hover {
        background: #0b5ed7;
      }

      .btn-toggle.dark-mode {
        background: #ffc107;
        color: black;
      }
      .btn-toggle.dark-mode:hover {
        background: #e0a800;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- Theme Toggle -->

    <button id="themeToggle" class="btn-toggle" onclick="toggleTheme()">
      ðŸŒ™
    </button>

    <div class="container mt-5">
      <h2 class="mb-4 text-center">ðŸ’° Expense Tracker</h2>

      <!-- Balance Cards -->
      <div class="row mb-4 text-center">
        <div class="col-md-4">
          <div class="card border-success shadow-sm">
            <div class="card-body">
              <h5>Balance</h5>
              <p class="fw-bold text-success">â‚¹{{ balance }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-primary shadow-sm">
            <div class="card-body">
              <h5>Income</h5>
              <p class="text-primary">â‚¹{{ income }}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-danger shadow-sm">
            <div class="card-body">
              <h5>Expense</h5>
              <p class="text-danger">â‚¹{{ expense }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Transaction Form -->
      <form method="POST" class="mb-4">
        <div class="row g-2">
          <div class="col-md-3">
            <select name="type" class="form-select" required>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>
          <div class="col-md-3">
            <input
              type="text"
              name="category"
              class="form-control"
              placeholder="Category"
              required
            />
          </div>
          <div class="col-md-3">
            <input
              type="number"
              name="amount"
              class="form-control"
              placeholder="Amount (â‚¹)"
              step="0.01"
              required
            />
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100" type="submit">Add</button>
          </div>
        </div>
      </form>

      <!-- Actions -->
      <div class="mb-3">
        <a href="/export_csv" class="btn btn-success btn-sm">ðŸ“„ Export CSV</a>
      </div>

      <!-- Transactions Table -->
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Category</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for t in transactions %}
            <tr>
              <td>{{ t[0] }}</td>
              <td
                class="{{ 'text-success' if t[1]=='income' else 'text-danger' }}"
              >
                {{ t[1] }}
              </td>
              <td>{{ t[2] }}</td>
              <td>â‚¹{{ t[3] }}</td>
              <td>{{ t[4] }}</td>
              <td>
                <a
                  href="/delete/{{ t[0] }}"
                  class="btn btn-sm btn-outline-danger"
                  >ðŸ—‘</a
                >
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Charts -->
      <div class="row mt-5 g-4">
        <div class="col-md-4">
          <canvas id="pieChart"></canvas>
        </div>
        <div class="col-md-4">
          <canvas id="barChart"></canvas>
        </div>
        <div class="col-md-4">
          <canvas id="lineChart"></canvas>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // Create charts array globally
      window.myCharts = [];

      // Theme Toggle Function
      function toggleTheme() {
          const isDark = document.body.classList.toggle('dark-mode');

          // Apply theme to UI elements
          document.querySelectorAll('.card, .form-control, .form-select, table, th, td')
              .forEach(el => el.classList.toggle('dark-mode', isDark));

          // Toggle button style + icon
          const themeBtn = document.getElementById('themeToggle');
          themeBtn.classList.toggle('dark-mode', isDark);
          themeBtn.textContent = isDark ? 'â˜€' : 'ðŸŒ™';

          // Update chart colors dynamically
          window.myCharts.forEach(chart => {
              chart.options.plugins.legend.labels.color = isDark ? '#e0e0e0' : '#000';
              if (chart.options.scales) {
                  Object.values(chart.options.scales).forEach(scale => {
                      if (scale.ticks) scale.ticks.color = isDark ? '#e0e0e0' : '#000';
                      if (scale.grid) scale.grid.color = isDark ? '#444' : '#ccc';
                  });
              }
              chart.update();
          });

          localStorage.setItem('theme', isDark ? 'dark' : 'light');
      }

      // Apply stored theme on load
      document.addEventListener('DOMContentLoaded', () => {
          const savedTheme = localStorage.getItem('theme');
          const themeBtn = document.getElementById('themeToggle');

          if (savedTheme === 'dark') {
              document.body.classList.add('dark-mode');
              document.querySelectorAll('.card, .form-control, .form-select, table, th, td')
                  .forEach(el => el.classList.add('dark-mode'));
              themeBtn.classList.add('dark-mode');
              themeBtn.textContent = 'â˜€';
          } else {
              themeBtn.textContent = 'ðŸŒ™';
          }

          // === Chart Data ===
          const categoryData = {{ category_data | tojson }};
          const labels = Object.keys(categoryData);
          const data = Object.values(categoryData);

          const lineLabels = {{ line_labels | tojson }};
          const lineValues = {{ line_values | tojson }};

          // === Create Charts and Save Instances ===
          window.myCharts.push(new Chart(document.getElementById('pieChart'), {
              type: 'pie',
              data: { labels, datasets: [{ data, backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#0d6efd', '#198754', '#6f42c1'] }] }
          }));

          window.myCharts.push(new Chart(document.getElementById('barChart'), {
              type: 'bar',
              data: { labels, datasets: [{ data, label: 'Expenses by Category', backgroundColor: '#0d6efd' }] }
          }));

          window.myCharts.push(new Chart(document.getElementById('lineChart'), {
              type: 'line',
              data: { labels: lineLabels, datasets: [{ label: 'Expenses Over Time', data: lineValues, borderColor: '#dc3545', fill: false }] }
          }));
      });
    </script>
  </body>
</html>
